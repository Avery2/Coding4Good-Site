<!doctype html>
<html>
<head>
    <% include template/head.ejs %>
    <script>
		var data =<%-JSON.stringify(allUserNameAndId)%>;

        function selectListFocus(){
            var list = $(".member-list").toArray();
            list.forEach(function (input) {
                // input.addEventListener("focus",$(input).attr("focused",true));
                // input.addEventListener("blur",$(input).attr("focused",false));
                $(input).click(function(){
                    input.value="";
                    $(input).trigger("change");
                });
                // clearValue();
            });
        }
        // function clearValue(){
        //     var list = $(".member-list").toArray();
        //     list.forEach(function (input) {
        //         input = $(input);
        //         if (input.attr("focused")) {
        //             input.click(function(){
        //                 input.val("");
        //             });
        //         }
        //         else{
        //             input.click(function(){input.attr("focused",true)});
        //         }
        //     });
        // }
        function addMemberRow() {
            var currentRow = $('.member-list').length/2+1;
            var html=" <div class=\"input-group new-project-input row\">\n" +
                "       <div class=\"input-group-addon\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Member "+currentRow+":&nbsp;&nbsp;&nbsp;</div>\n" +
                "       <select id=\"name"+currentRow+"\" class=\"form-control member-list\">\n" +
                "           <% allUserNameAndId.forEach(function(user){ %>\n" +
                "           <option id=\"<%= user.id %>\" value=\"<%= user.id %>\"><%= user.name %></option>\n" +
                "           <% }) %>\n" +
                "       </select>\n" +
                "       <div class=\"input-group-addon\">Member Title:</div>\n" +
                "       <select id=\"title"+currentRow+"\" class=\"form-control member-list\">\n" +
                "           <option>Manager</option>\n" +
                "           <option>Leader</option>\n" +
                "           <option>Member</option>\n" +
                "       </select>\n" +
                "   </div>";
            $('#member-input-space').append(html);
            $(".member-list").editableSelect({effects: 'slide'});
            selectListFocus();
        }
        $(function () {
            addMemberRow();
            $('.member-list').editableSelect({effects: 'slide'});
            $('#add-member-button').click(function(){
                addMemberRow();
            });
            var statusHtml = ""
            for (var status in StatusEnum) {
                if (isNaN(Number(status))) {
                    statusHtml += "<option value=\"" + status + "\">" + status + "</option>";
                }
            }
            $('#status').html(statusHtml);
            $("#project-form").submit(function () {
                var validInput = true;
                $("#error-msg").html("");
                if (($("#title").val() == '') | ($("#description").val() == '') | ($("#contact").val() == '') | ($("#npo").val() == '')) {
                    $("#error-msg").html('Please fill out all the fields');
                    validInput = false;
                }
                var teamMembers = $(".member-list");
				var teams = [];
				for(var i=0;i<teamMembers.length;i+=2){
					var name = teamMembers[i].value;
					var id = $(teamMembers[i]).attr("data-value");
					var title = teamMembers[i+1].value;
                    var foundMembers = false;
					data.forEach(function(people){
						if(people.id==id){
						    foundMembers = true;
							if(title===""){
								$("#error-msg").html('Please input a title for member '+(i/2+1));
                                validInput = false;
							}
							if(people.name===name){
								teams.push({id: id, memberTitle:title});
							}
							else{
								$("#error-msg").html('Member '+i+" is not a valid member");
                                validInput = false;
							}
						}
						if(!foundMembers){
                            if(name==="" && title!=""){
                                $("#error-msg").html('Please input valid name for member '+(i/2+1));
                                validInput = false;
                            }
                        }
					});
				}
				if(validInput){
                    $.ajax({
                        url: "/api/project/createProject",
                        method: "POST",
                        dataType: "json",
                        data: {
                            title: $("#title").val(),
                            description: $("#description").val(),
                            contact: $("#contact").val(),
                            npo: $("#npo").val(),
                            status: $("#status").val(),
                            team: teams
                        },
                        success: function () {
                            window.location.href = "/project";
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            $("#error-msg").html(jqXHR.responseJSON);
                        }
                    });
                }
                return false;
            });
        });
    </script>
</head>
<body>

<% include template/nav.ejs %>
<div class="creat-project">
    <div class="col-sm-8-offset" align="right">
        <a class="btn primary-button" href="/project">Back</a>
    </div>
    <p class="error-msg" id="error-msg"></p>
    <form id="project-form">
        <div class="input-group new-project-input">
            <div class="input-group-addon">Project Title:&nbsp;</div>
            <input class="form-control" type="text" id="title" placeholder="Title">
        </div>

        <div class="input-group new-project-input row">
            <div class="input-group-addon">Team Members: </div>
            <div class="form-control ">
                <div class="col-sm-6 img-center-holder divider-vertical">Name</div>
                <div class="col-sm-6 img-center-holder">Member Title</div>
            </div>
            <div class="input-group-btn">
                <button type="button" id="add-member-button" class="btn primary-button">Add Members</button>
            </div>
        </div>
        <div id="member-input-space">
            <!--member row goes here-->
        </div>

        <div class="input-group new-project-input">
            <div class="input-group-addon">Project status:</div>
            <select class="form-control" id="status">

            </select>
        </div>

        <div class="input-group new-project-input">
            <div class="input-group-addon">Contact Information:</div>
            <input class="form-control" type="text" id="contact" placeholder="Contact">
        </div>

        <div class="input-group new-project-input">
            <div class="input-group-addon">Non-profit Organization Name:</div>
            <input class="form-control" type="text" id="npo" placeholder="Non-profit Organization Name">
        </div>

        <div class="new-project-input">
            <textarea class="form-control" type="text" id="description" placeholder="Description" rows="10"></textarea>
        </div>

    </form>
    <button type="submit" form="project-form" class="btn login-signup-btn primary-button">Create!</button>
</div>

<% include template/footer.ejs %>
</body>
</html>
